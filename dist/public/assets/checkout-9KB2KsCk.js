import{aL as Ie,aM as Re,ah as d,k as ue,u as le,r as P,a as Z,j as a,B as M,aN as ee,C as D,O as J,V,aO as Le,f as F,aP as Te,e as Ae,aQ as te}from"./index-68JtM4Cd.js";import{A as qe}from"./arrow-left-DWRgMh92.js";var _e=Re();const p=Ie(_e);function re(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(o){return Object.getOwnPropertyDescriptor(r,o).enumerable})),t.push.apply(t,n)}return t}function ne(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?re(Object(t),!0).forEach(function(n){de(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):re(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function U(r){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?U=function(e){return typeof e}:U=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},U(r)}function de(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Ue(r,e){if(r==null)return{};var t={},n=Object.keys(r),o,s;for(s=0;s<n.length;s++)o=n[s],!(e.indexOf(o)>=0)&&(t[o]=r[o]);return t}function Me(r,e){if(r==null)return{};var t=Ue(r,e),n,o;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);for(o=0;o<s.length;o++)n=s[o],!(e.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(r,n)&&(t[n]=r[n])}return t}function pe(r,e){return We(r)||Be(r,e)||$e(r,e)||Ke()}function We(r){if(Array.isArray(r))return r}function Be(r,e){var t=r&&(typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"]);if(t!=null){var n=[],o=!0,s=!1,c,m;try{for(t=t.call(r);!(o=(c=t.next()).done)&&(n.push(c.value),!(e&&n.length===e));o=!0);}catch(i){s=!0,m=i}finally{try{!o&&t.return!=null&&t.return()}finally{if(s)throw m}}return n}}function $e(r,e){if(r){if(typeof r=="string")return ae(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return ae(r,e)}}function ae(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function Ke(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var b=function(e,t,n){var o=!!n,s=d.useRef(n);d.useEffect(function(){s.current=n},[n]),d.useEffect(function(){if(!o||!e)return function(){};var c=function(){s.current&&s.current.apply(s,arguments)};return e.on(t,c),function(){e.off(t,c)}},[o,t,e,s])},X=function(e){var t=d.useRef(e);return d.useEffect(function(){t.current=e},[e]),t.current},O=function(e){return e!==null&&U(e)==="object"},De=function(e){return O(e)&&typeof e.then=="function"},Je=function(e){return O(e)&&typeof e.elements=="function"&&typeof e.createToken=="function"&&typeof e.createPaymentMethod=="function"&&typeof e.confirmCardPayment=="function"},oe="[object Object]",Ve=function r(e,t){if(!O(e)||!O(t))return e===t;var n=Array.isArray(e),o=Array.isArray(t);if(n!==o)return!1;var s=Object.prototype.toString.call(e)===oe,c=Object.prototype.toString.call(t)===oe;if(s!==c)return!1;if(!s&&!n)return e===t;var m=Object.keys(e),i=Object.keys(t);if(m.length!==i.length)return!1;for(var g={},j=0;j<m.length;j+=1)g[m[j]]=!0;for(var C=0;C<i.length;C+=1)g[i[C]]=!0;var u=Object.keys(g);if(u.length!==m.length)return!1;var S=e,l=t,h=function(k){return r(S[k],l[k])};return u.every(h)},fe=function(e,t,n){return O(e)?Object.keys(e).reduce(function(o,s){var c=!O(t)||!Ve(e[s],t[s]);return n.includes(s)?(c&&console.warn("Unsupported prop change: options.".concat(s," is not a mutable property.")),o):c?ne(ne({},o||{}),{},de({},s,e[s])):o},null):null},me="Invalid prop `stripe` supplied to `Elements`. We recommend using the `loadStripe` utility from `@stripe/stripe-js`. See https://stripe.com/docs/stripe-js/react#elements-props-stripe for details.",se=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:me;if(e===null||Je(e))return e;throw new Error(t)},Fe=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:me;if(De(e))return{tag:"async",stripePromise:Promise.resolve(e).then(function(o){return se(o,t)})};var n=se(e,t);return n===null?{tag:"empty"}:{tag:"sync",stripe:n}},Xe=function(e){!e||!e._registerWrapper||!e.registerAppInfo||(e._registerWrapper({name:"react-stripe-js",version:"3.9.0"}),e.registerAppInfo({name:"react-stripe-js",version:"3.9.0",url:"https://stripe.com/docs/stripe-js/react"}))},W=d.createContext(null);W.displayName="ElementsContext";var he=function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e},ve=function(e){var t=e.stripe,n=e.options,o=e.children,s=d.useMemo(function(){return Fe(t)},[t]),c=d.useState(function(){return{stripe:s.tag==="sync"?s.stripe:null,elements:s.tag==="sync"?s.stripe.elements(n):null}}),m=pe(c,2),i=m[0],g=m[1];d.useEffect(function(){var u=!0,S=function(h){g(function(f){return f.stripe?f:{stripe:h,elements:h.elements(n)}})};return s.tag==="async"&&!i.stripe?s.stripePromise.then(function(l){l&&u&&S(l)}):s.tag==="sync"&&!i.stripe&&S(s.stripe),function(){u=!1}},[s,i,n]);var j=X(t);d.useEffect(function(){j!==null&&j!==t&&console.warn("Unsupported prop change on Elements: You cannot change the `stripe` prop after setting it.")},[j,t]);var C=X(n);return d.useEffect(function(){if(i.elements){var u=fe(n,C,["clientSecret","fonts"]);u&&i.elements.update(u)}},[n,C,i.elements]),d.useEffect(function(){Xe(i.stripe)},[i.stripe]),d.createElement(W.Provider,{value:i},o)};ve.propTypes={stripe:p.any,options:p.object};var ze=function(e){var t=d.useContext(W);return he(t,e)},Ye=function(){var e=ze("calls useElements()"),t=e.elements;return t};p.func.isRequired;var ye=d.createContext(null);ye.displayName="CheckoutSdkContext";var Ge=function(e,t){if(!e)throw new Error("Could not find CheckoutProvider context; You need to wrap the part of your app that ".concat(t," in an <CheckoutProvider> provider."));return e},Qe=d.createContext(null);Qe.displayName="CheckoutContext";p.any,p.shape({fetchClientSecret:p.func.isRequired,elementsOptions:p.object}).isRequired;var z=function(e){var t=d.useContext(ye),n=d.useContext(W);if(t&&n)throw new Error("You cannot wrap the part of your app that ".concat(e," in both <CheckoutProvider> and <Elements> providers."));return t?Ge(t,e):he(n,e)},He=["mode"],Ze=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},v=function(e,t){var n="".concat(Ze(e),"Element"),o=function(i){var g=i.id,j=i.className,C=i.options,u=C===void 0?{}:C,S=i.onBlur,l=i.onFocus,h=i.onReady,f=i.onChange,k=i.onEscape,I=i.onClick,B=i.onLoadError,Se=i.onLoaderStart,Ee=i.onNetworksChange,be=i.onConfirm,ke=i.onCancel,we=i.onShippingAddressChange,Ne=i.onShippingRateChange,T=z("mounts <".concat(n,">")),A="elements"in T?T.elements:null,w="checkoutSdk"in T?T.checkoutSdk:null,Pe=d.useState(null),Y=pe(Pe,2),E=Y[0],Oe=Y[1],N=d.useRef(null),$=d.useRef(null);b(E,"blur",S),b(E,"focus",l),b(E,"escape",k),b(E,"click",I),b(E,"loaderror",B),b(E,"loaderstart",Se),b(E,"networkschange",Ee),b(E,"confirm",be),b(E,"cancel",ke),b(E,"shippingaddresschange",we),b(E,"shippingratechange",Ne),b(E,"change",f);var K;h&&(e==="expressCheckout"?K=h:K=function(){h(E)}),b(E,"ready",K),d.useLayoutEffect(function(){if(N.current===null&&$.current!==null&&(A||w)){var x=null;if(w)switch(e){case"payment":x=w.createPaymentElement(u);break;case"address":if("mode"in u){var Q=u.mode,H=Me(u,He);if(Q==="shipping")x=w.createShippingAddressElement(H);else if(Q==="billing")x=w.createBillingAddressElement(H);else throw new Error("Invalid options.mode. mode must be 'billing' or 'shipping'.")}else throw new Error("You must supply options.mode. mode must be 'billing' or 'shipping'.");break;case"expressCheckout":x=w.createExpressCheckoutElement(u);break;case"currencySelector":x=w.createCurrencySelectorElement();break;case"taxId":x=w.createTaxIdElement(u);break;default:throw new Error("Invalid Element type ".concat(n,". You must use either the <PaymentElement />, <AddressElement options={{mode: 'shipping'}} />, <AddressElement options={{mode: 'billing'}} />, or <ExpressCheckoutElement />."))}else A&&(x=A.create(e,u));N.current=x,Oe(x),x&&x.mount($.current)}},[A,w,u]);var G=X(u);return d.useEffect(function(){if(N.current){var x=fe(u,G,["paymentRequest"]);x&&"update"in N.current&&N.current.update(x)}},[u,G]),d.useLayoutEffect(function(){return function(){if(N.current&&typeof N.current.destroy=="function")try{N.current.destroy(),N.current=null}catch{}}},[]),d.createElement("div",{id:g,className:j,ref:$})},s=function(i){z("mounts <".concat(n,">"));var g=i.id,j=i.className;return d.createElement("div",{id:g,className:j})},c=t?s:o;return c.propTypes={id:p.string,className:p.string,onChange:p.func,onBlur:p.func,onFocus:p.func,onReady:p.func,onEscape:p.func,onClick:p.func,onLoadError:p.func,onLoaderStart:p.func,onNetworksChange:p.func,onConfirm:p.func,onCancel:p.func,onShippingAddressChange:p.func,onShippingRateChange:p.func,options:p.object},c.displayName=n,c.__elementType=e,c},y=typeof window>"u",et=d.createContext(null);et.displayName="EmbeddedCheckoutProviderContext";var tt=function(){var e=z("calls useStripe()"),t=e.stripe;return t};v("auBankAccount",y);v("card",y);v("cardNumber",y);v("cardExpiry",y);v("cardCvc",y);v("fpxBank",y);v("iban",y);v("idealBank",y);v("p24Bank",y);v("epsBank",y);var rt=v("payment",y);v("expressCheckout",y);v("currencySelector",y);v("paymentRequestButton",y);v("linkAuthentication",y);v("address",y);v("shippingAddress",y);v("paymentMethodMessaging",y);v("affirmMessage",y);v("afterpayClearpayMessage",y);v("taxId",y);var ge="basil",nt=function(e){return e===3?"v3":e},xe="https://js.stripe.com",at="".concat(xe,"/").concat(ge,"/stripe.js"),ot=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,st=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var it=function(e){return ot.test(e)||st.test(e)},ct=function(){for(var e=document.querySelectorAll('script[src^="'.concat(xe,'"]')),t=0;t<e.length;t++){var n=e[t];if(it(n.src))return n}return null},ie=function(e){var t="",n=document.createElement("script");n.src="".concat(at).concat(t);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(n),n},ut=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"7.8.0",startTime:t})},R=null,q=null,_=null,lt=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},dt=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},pt=function(e){return R!==null?R:(R=new Promise(function(t,n){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe){t(window.Stripe);return}try{var o=ct();if(!(o&&e)){if(!o)o=ie(e);else if(o&&_!==null&&q!==null){var s;o.removeEventListener("load",_),o.removeEventListener("error",q),(s=o.parentNode)===null||s===void 0||s.removeChild(o),o=ie(e)}}_=dt(t,n),q=lt(n),o.addEventListener("load",_),o.addEventListener("error",q)}catch(c){n(c);return}}),R.catch(function(t){return R=null,Promise.reject(t)}))},ft=function(e,t,n){if(e===null)return null;var o=t[0],s=o.match(/^pk_test/),c=nt(e.version),m=ge;s&&c!==m&&console.warn("Stripe.js@".concat(c," was loaded on the page, but @stripe/stripe-js@").concat("7.8.0"," expected Stripe.js@").concat(m,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var i=e.apply(void 0,t);return ut(i,n),i},L,je=!1,Ce=function(){return L||(L=pt(null).catch(function(e){return L=null,Promise.reject(e)}),L)};Promise.resolve().then(function(){return Ce()}).catch(function(r){je||console.warn(r)});var mt=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];je=!0;var o=Date.now();return Ce().then(function(s){return ft(s,t,o)})};let ce=null;function ht({cartItems:r,customerInfo:e,shippingAddress:t,paymentIntentId:n}){const o=tt(),s=Ye(),{toast:c}=ue(),[,m]=le(),[i,g]=P.useState(!1),j=async l=>{if(l.preventDefault(),!(!o||!s)){g(!0);try{const{error:h}=await o.confirmPayment({elements:s,confirmParams:{return_url:`${window.location.origin}/checkout/success`},redirect:"if_required"});if(h)c({title:"Error en el pago",description:h.message,variant:"destructive"});else try{await Ae("/api/store/checkout",{method:"POST",body:JSON.stringify({paymentIntentId:n,customerInfo:e,shippingAddress:t,orderItems:r.map(f=>({productId:f.product.id,quantity:f.quantity}))})}),localStorage.removeItem("checkoutItems"),localStorage.removeItem("checkout-info"),localStorage.removeItem("shopping-cart"),te.invalidateQueries({queryKey:["/api/store/products"]}),te.invalidateQueries({queryKey:["/api/store/stats"]}),window.dispatchEvent(new CustomEvent("checkoutComplete")),c({title:"¡Pago exitoso!",description:"Tu pedido ha sido procesado correctamente"}),m("/checkout/success")}catch(f){console.error("Order creation error:",f),c({title:"Error",description:`El pago se procesó pero hubo un problema creando el pedido: ${f.message||"Error desconocido"}`,variant:"destructive"})}}catch{c({title:"Error",description:"Ocurrió un error procesando el pago",variant:"destructive"})}finally{g(!1)}}},C=()=>{const l=r.reduce((h,f)=>{const k=f.product.price||0,I=f.quantity||1;return h+k*I},0);return console.log("Total calculated:",l,"from items:",r),l},u=(l,h="MXN")=>(l/100).toLocaleString("es-MX",{style:"currency",currency:h}),S=()=>r.length>0&&r[0].product.currency||"MXN";return a.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[a.jsxs("div",{className:"mb-6",children:[a.jsxs(M,{variant:"ghost",onClick:()=>m("/shipping-info"),className:"mb-4",children:[a.jsx(qe,{className:"w-4 h-4 mr-2"}),"Volver"]}),a.jsxs("div",{className:"text-center",children:[a.jsx(ee,{className:"w-12 h-12 mx-auto mb-4 text-blue-600"}),a.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Finalizar Compra"}),a.jsx("p",{className:"text-muted-foreground",children:"Completa tu pago de forma segura"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[a.jsxs("div",{className:"space-y-6",children:[a.jsxs(D,{children:[a.jsx(J,{children:a.jsxs(V,{className:"flex items-center gap-2",children:[a.jsx(Le,{className:"w-5 h-5"}),"Resumen del Pedido"]})}),a.jsx(F,{children:a.jsxs("div",{className:"space-y-4",children:[r.map((l,h)=>a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h4",{className:"font-medium",children:l.product.name}),a.jsxs("p",{className:"text-sm text-muted-foreground",children:["Cantidad: ",l.quantity]})]}),a.jsx("div",{className:"text-right",children:a.jsx("p",{className:"font-medium",children:u(l.product.price*l.quantity,l.product.currency)})})]},h)),a.jsx("div",{className:"border-t pt-4",children:a.jsxs("div",{className:"flex justify-between items-center font-bold text-lg",children:[a.jsx("span",{children:"Total:"}),a.jsx("span",{children:u(C(),S())})]})})]})})]}),a.jsxs(D,{children:[a.jsx(J,{children:a.jsx(V,{children:"Información de Envío"})}),a.jsx(F,{children:a.jsxs("div",{className:"space-y-2 text-sm",children:[a.jsx("p",{children:a.jsxs("strong",{children:[t.firstName," ",t.lastName]})}),a.jsx("p",{children:t.address1}),t.address2&&a.jsx("p",{children:t.address2}),a.jsxs("p",{children:[t.city,", ",t.state," ",t.zipCode]}),a.jsx("p",{children:t.country}),t.phone&&a.jsxs("p",{children:["Tel: ",t.phone]})]})})]})]}),a.jsx("div",{children:a.jsxs("form",{onSubmit:j,className:"space-y-6",children:[a.jsxs(D,{children:[a.jsx(J,{children:a.jsxs(V,{className:"flex items-center gap-2",children:[a.jsx(ee,{className:"w-5 h-5"}),"Información de Pago"]})}),a.jsx(F,{children:a.jsx(rt,{})})]}),a.jsx(M,{type:"submit",disabled:!o||i,className:"w-full",size:"lg",children:i?a.jsxs(a.Fragment,{children:[a.jsx(Te,{className:"w-4 h-4 mr-2 animate-spin"}),"Procesando..."]}):`Pagar ${u(C(),S())}`})]})})]})]})}function gt(){const{toast:r}=ue(),[,e]=le(),[t,n]=P.useState([]),[o,s]=P.useState(null),[c,m]=P.useState(null);P.useEffect(()=>{const u=localStorage.getItem("checkoutItems");u&&n(JSON.parse(u));const S=localStorage.getItem("checkout-info");if(S){const l=JSON.parse(S);s(l.customerInfo),m(l.shippingAddress)}else{r({title:"Información incompleta",description:"Completa la información de envío primero",variant:"destructive"}),e("/shipping-info");return}},[e,r]);const{data:i}=Z({queryKey:["/api/payment-config/public"]});P.useEffect(()=>{i?.stripePublicKey&&(ce=mt(i.stripePublicKey))},[i]);const{data:g,isLoading:j,error:C}=Z({queryKey:["/api/create-payment-intent",t],queryFn:async()=>{if(t.length===0)throw new Error("No hay productos en el carrito");const u=t.reduce((f,k)=>{const I=k.product.price||0,B=k.quantity||1;return f+I*B},0);if(u<=0)throw new Error("El total del pedido debe ser mayor a 0");const S=t[0]?.product?.currency||"MXN";console.log("Creating payment intent:",{total:u,currency:S,items:t.length});const l=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:u/100,currency:S.toLowerCase(),cartItems:t.map(f=>({productId:f.product.id,quantity:f.quantity}))})});if(!l.ok){const f=await l.text();throw console.error("Payment intent creation failed:",l.status,f),new Error(`Error ${l.status}: ${f}`)}const h=await l.json();return console.log("Payment intent created successfully:",h),h},enabled:t.length>0&&!!i?.stripePublicKey&&!!o&&!!c,retry:3,retryDelay:1e3});return!o||!c||t.length===0?a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),a.jsx("p",{children:"Cargando información del pedido..."})]})}):i?.stripePublicKey?C?a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsxs("p",{className:"text-red-600 mb-4",children:["Error al inicializar el pago: ",C.message]}),a.jsx(M,{onClick:()=>e("/shipping-info"),children:"Volver atrás"})]})}):j||!g?a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),a.jsx("p",{children:"Iniciando pago..."}),a.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Esto puede tomar unos segundos"})]})}):a.jsx("div",{className:"min-h-screen bg-gray-50",children:a.jsx(ve,{stripe:ce,options:{clientSecret:g.clientSecret,appearance:{theme:"stripe"}},children:a.jsx(ht,{cartItems:t,customerInfo:o,shippingAddress:c,paymentIntentId:g.paymentIntentId})})}):a.jsx("div",{className:"min-h-screen flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-red-600 mb-4",children:"Error: Configuración de pagos no disponible"}),a.jsx(M,{onClick:()=>e("/shipping-info"),children:"Volver atrás"})]})})}export{gt as default};
